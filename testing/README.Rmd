<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r "setup", include = FALSE}
library(rcmdcheck)
library(knitr)
library(data.table)
options(knitr.kable.NA = '')
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  results = "hide"
)
```

# Testing medicalcoder

Along with GitHub Actions and local tests, the workflow in this directory will
test a recent local build of `medicalcoder` against every major and minor
release of R from 3.5.0 through the latest version, with, and without, suggested
packages.  The tests are done in [Docker](https://www.docker.com/) images based
on the [R-base](https://hub.docker.com/_/r-base) images.

## System Requirements:
To run the tests you need

* [Docker Desktop](https://www.docker.com/products/docker-desktop/)
* [GNU Make](https://www.gnu.org/software/make/)

Just run `make` from this directory.

# Last Testing Results

```{r}
check_logs <- list.files(path = ".", pattern = "00check.log", full.name = TRUE, recursive = TRUE)
checks <- sapply(check_logs, parse_check, simplify = FALSE)

for (i in seq_along(checks)) {
  checks[[i]][["errors"]] <- gsub("\\n", " ", checks[[i]][["errors"]])
  checks[[i]][["warnings"]] <- gsub("\\n", " ", checks[[i]][["warnings"]])
  checks[[i]][["notes"]] <- gsub("\\n", " ", checks[[i]][["notes"]])
}

errors <- lapply(checks, getElement, "errors")
unique(errors)

warnings <- lapply(checks, getElement, "warnings")
unique(warnings)

notes <- lapply(checks, getElement, "notes")
unique(notes)

DT <-
  checks |>
  lapply(
    function(x) {
      with(x,
        data.table(
          rversion,
          status,
          errors   = ifelse(length(errors) > 0, errors, NA_character_),
          warnings = ifelse(length(warnings) > 0, warnings, NA_character_),
          notes    = ifelse(length(notes) > 0, notes, NA_character_),
          checkdir,
          version
        )
      )
    }
  ) |>
  rbindlist()

DT[, suggests := fifelse(grepl("R-.+without-suggests.+$", DT$checkdir), "Without Suggested Packages", "With Suggested Packages")]
DT[, checkdir := NULL]
DT <- unique(DT)

DT[, errors   := factor(errors)]
DT[, warnings := factor(warnings)]
DT[, notes    := factor(notes)]
setkey(DT, suggests, rversion)
```

```{r results = "asis"}
kableExtra::kbl(
  x = DT[, .(
    "R Version" = rversion,
    #"Suggested Packages" = suggests,
    "Status" = status,
    "Error"  = fifelse(errors == "", "", paste("Error", as.numeric(errors))),
    "Warning"  = fifelse(warnings == "", "", paste("Warning", as.numeric(warnings))),
    "Note"  = fifelse(notes == "", "", paste("Note", as.numeric(notes)))
    )],
  align = "cccccc",
  format = "markdown"
  ) |>
kableExtra::pack_rows(index = table(DT$suggests))

cat(
  "* Errors:",
  if (nlevels(DT$errors)) { paste0("  ", seq_len(nlevels(DT$errors)), ". ", levels(DT$errors)) },
  sep = "\n"
)

cat(
  "* Warnings:",
  if (nlevels(DT$warnings)) { paste0("  ", seq_len(nlevels(DT$warnings)), ". ", levels(DT$warnings)) },
  sep = "\n"
)

cat(
  "* Notes:",
  if (nlevels(DT$notes)) { paste0("  ", seq_len(nlevels(DT$notes)), ". ", levels(DT$notes)) },
  sep = "\n"
)
```

